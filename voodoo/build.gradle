import org.apache.tools.ant.filters.ReplaceTokens
import proguard.gradle.ProGuardTask

plugins {
    id 'application'
}

apply plugin: 'com.github.johnrengelman.shadow'

mainClassName = "voodoo.Voodoo"

def runDir = project.file("run").path

shadowJar {
    classifier = null
}

dependencies {
    compile project(':core')
    compile project(':util')
    compile project(':flatten')
    compile project(':builder')
    compile project(':pack')
}

build.dependsOn(shadowJar)

version = "${project.major}.${project.minor}.${project.patch}"
compileKotlin.doFirst {
    copy {
        from "../template/kotlin/voodoo/"
        into "src/main/kotlin/${project.name}"
        expand(
                PACKAGE: project.name,
                MAJOR_VERSION: project.major,
                MINOR_VERSION: project.minor,
                PATCH_VERSION: project.patch
        )
    }
}

task proguard(type: ProGuardTask, dependsOn: shadowJar) {
    libraryjars "${System.getProperty('java.home')}/lib/rt.jar"
    injars shadowJar.archivePath
    outjars "build/libs/proguard.jar"
    keep 'class voodoo.Voodoo { *; }'

    keep 'class org.slf4j.**'
    keep 'interface org.slf4j.**'
    keep 'enum org.slf4j.**'

    keep '@com.fasterxml.jackson.annotation.JsonIgnoreProperties class * { *; }'
    keep 'class com.fasterxml.** { *; }'
    keep 'class org.codehaus.** { *; }'
    keepnames 'class com.fasterxml.jackson.** { *; }'
    keepclassmembers '''
        public final enum com.fasterxml.jackson.annotation.JsonAutoDetect$Visibility {
            public static final com.fasterxml.jackson.annotation.JsonAutoDetect$Visibility *;
        }
        '''
}
